name: SPICE

on:
  schedule:
    - cron: "0 16 * * 4"
  workflow_dispatch:

jobs:
  code:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        julia-version: [1]
        julia-arch: [x86]
        os: [ubuntu-latest]
    steps:
      - uses: julia-actions/setup-julia@latest
        with:
          version: ${{ matrix.julia-version }}
      - name: Install dependencies
        run:
          julia --project=gen/ -e 'run(`ls $(pwd())`)'
          # julia --project=gen/ -e 'using Pkg; Pkg.develop(PackageSpec(path=pwd())); Pkg.instantiate()'
      - name: Run Regression
        run: JULIA_DEBUG=Main,SPICEKernels julia --project=gen gen/make.jl
      - name: Bump Version
        run: if [ -n "$(git status --porcelain)" ]; then
          julia --project -e 'begin
          using TOML
          project = TOML.parsefile("Project.toml")
          version = let version = project["version"]
          @eval @v_str $version
          end

          major = version.major
          minor = version.minor
          patch = version.patch + 1

          project["version"] = "$major.$minor.$patch"

          open("Project.toml", "w") do file
          TOML.print(file, project)
          end
          end';
  pull-request:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v3
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
